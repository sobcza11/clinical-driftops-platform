name: DriftOps CI
on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run tests
        run: pytest -q -vv

      - name: Build reports with validator (fail closed)
        env:
          PYTHONPATH: .
          DRIFTOPS_ENABLE_EXTERNAL: "0"
        run: |
          rm -rf reports && mkdir -p reports
          cat > reports/predictions.csv <<'CSV'
          y_true,y_pred_prob
          1,0.91
          0,0.12
          1,0.77
          0,0.05
          CSV
          python src/api/validate_cli.py --preds reports/predictions.csv
          python src/reports_dashboard.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: driftops-reports
          path: reports/

      - name: Build trustworthy audit
        env:
          PYTHONPATH: .
        run: |
          python -m src.eval.make_trustworthy_audit --reports reports

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: driftops-reports
          path: reports/


      - name: Policy Gate
        run: |
          python -m src.ops.policy_validator

      - name: Trustworthy Audit
        run: |
          python -m src.eval.make_trustworthy_audit --reports reports

      - name: Build Dashboard
        run: |
          python src/reports_dashboard.py



      - name: Validate policy gate
        run: python src/ops/policy_validator.py

      - name: Make Trustworthy Audit
        run: python src/eval/make_trustworthy_audit.py

      - name: Build dashboard
        run: python src/reports_dashboard.py

      # (Optional) Upload the reports folder as an artifact so you can download it from Actions
      - name: Upload reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: driftops-reports
          path: reports/
